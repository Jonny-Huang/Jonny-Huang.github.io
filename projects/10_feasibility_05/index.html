<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;jonny-huang.github.io&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Mist&quot;,&quot;version&quot;:&quot;8.5.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;always&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:false,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜尋...&quot;,&quot;empty&quot;:&quot;我們無法找到任何有關 ${query} 的搜索結果&quot;,&quot;hits_time&quot;:&quot;${hits} 找到 ${time} 個結果&quot;,&quot;hits&quot;:&quot;找到 ${hits} 個結果&quot;}}</script><script src="/js/config.js"></script>
<meta name="description" content="前言在上一篇 化繁為簡：04 後端篇(三)REST 我們最後建立一個 內含 REST 服務的 ProductsController，但是實務上，一般不會直接透過 GET 將清單資料一次全部下載，因為當資料筆數過大時有可能會被中斷，所以我們需要再提供分批下載的功能，此外對於基本資料的處理來說，一但扣除掉因資料特性而有所差異的商業邏輯，Controller 的程式碼幾乎雷同，所以這一篇我們就嘗試">
<meta property="og:type" content="article">
<meta property="og:title" content="化繁為簡：05 後端篇(四)Controller">
<meta property="og:url" content="https://jonny-huang.github.io/projects/10_feasibility_05/index.html">
<meta property="og:site_name" content="Jonny Huang 的學習筆記">
<meta property="og:description" content="前言在上一篇 化繁為簡：04 後端篇(三)REST 我們最後建立一個 內含 REST 服務的 ProductsController，但是實務上，一般不會直接透過 GET 將清單資料一次全部下載，因為當資料筆數過大時有可能會被中斷，所以我們需要再提供分批下載的功能，此外對於基本資料的處理來說，一但扣除掉因資料特性而有所差異的商業邏輯，Controller 的程式碼幾乎雷同，所以這一篇我們就嘗試">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://jonny-huang.github.io/images/projects/feasibility/05/feasibility_05_001.png">
<meta property="og:image" content="https://jonny-huang.github.io/images/projects/feasibility/05/feasibility_05_002.png">
<meta property="og:image" content="https://jonny-huang.github.io/images/projects/feasibility/05/feasibility_05_003.png">
<meta property="og:image" content="https://jonny-huang.github.io/images/projects/feasibility/05/feasibility_05_004.png">
<meta property="og:image" content="https://jonny-huang.github.io/images/projects/feasibility/05/feasibility_05_007.png">
<meta property="og:image" content="https://jonny-huang.github.io/images/projects/feasibility/05/feasibility_05_005.png">
<meta property="og:image" content="https://jonny-huang.github.io/images/projects/feasibility/05/feasibility_05_008.png">
<meta property="og:image" content="https://jonny-huang.github.io/images/projects/feasibility/05/feasibility_05_006.png">
<meta property="og:image" content="https://jonny-huang.github.io/images/projects/feasibility/05/feasibility_05_009.png">
<meta property="og:image" content="https://jonny-huang.github.io/images/projects/feasibility/05/feasibility_05_010.png">
<meta property="og:image" content="https://jonny-huang.github.io/images/projects/feasibility/05/feasibility_05_011.png">
<meta property="article:published_time" content="2021-06-28T16:00:00.000Z">
<meta property="article:modified_time" content="2021-06-30T03:06:58.220Z">
<meta property="article:author" content="Jonny Huang">
<meta property="article:tag" content="Projects">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jonny-huang.github.io/images/projects/feasibility/05/feasibility_05_001.png">


<link rel="canonical" href="https://jonny-huang.github.io/projects/10_feasibility_05/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;zh-TW&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;https:&#x2F;&#x2F;jonny-huang.github.io&#x2F;projects&#x2F;10_feasibility_05&#x2F;&quot;,&quot;path&quot;:&quot;projects&#x2F;10_feasibility_05&#x2F;&quot;,&quot;title&quot;:&quot;化繁為簡：05 後端篇(四)Controller&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>化繁為簡：05 後端篇(四)Controller | Jonny Huang 的學習筆記</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Jonny Huang 的學習筆記</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Angular、Flutter</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>目錄</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔</a></li>
        <li class="menu-item menu-item-flutter"><a href="/flutter/" rel="section"><i class="fa fa-tags fa-fw"></i>Flutter</a></li>
        <li class="menu-item menu-item-angular"><a href="/angular/" rel="section"><i class="fa fa-tags fa-fw"></i>Angular</a></li>
        <li class="menu-item menu-item-projects"><a href="/projects/" rel="section"><i class="fa fa-tags fa-fw"></i>projects</a></li>
        <li class="menu-item menu-item-quotes"><a href="/quotes/" rel="section"><i class="fa fa fa-tags fa-fw"></i>欣雨露</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CloudContext-%E5%A2%9E%E8%82%A5"><span class="nav-number">2.</span> <span class="nav-text">CloudContext 增肥</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Controller-%E6%8A%BD%E9%9B%A2"><span class="nav-number">3.</span> <span class="nav-text">Controller 抽離</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%B9%E6%AC%A1%E5%82%B3%E8%BC%B8"><span class="nav-number">3.1.</span> <span class="nav-text">批次傳輸</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9-ProductsController"><span class="nav-number">4.</span> <span class="nav-text">修改 ProductsController</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BE%8C%E8%A8%98"><span class="nav-number">5.</span> <span class="nav-text">後記</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jonny Huang"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Jonny Huang</p>
  <div class="site-description" itemprop="description">Jonny Huang 的學習筆記</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">77</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分類</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">標籤</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="mailto:jonnyhuang@outlook.com" title="E-Mail → mailto:jonnyhuang@outlook.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.facebook.com/groups/flutter.tw/" title="https:&#x2F;&#x2F;www.facebook.com&#x2F;groups&#x2F;flutter.tw&#x2F;" rel="noopener" target="_blank">Flutter Taiwan</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.facebook.com/groups/augularjs.tw/" title="https:&#x2F;&#x2F;www.facebook.com&#x2F;groups&#x2F;augularjs.tw&#x2F;" rel="noopener" target="_blank">Angular Taiwan</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://forum.angular.tw/" title="https:&#x2F;&#x2F;forum.angular.tw&#x2F;" rel="noopener" target="_blank">Angular Taiwan 論壇</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="回到頂端">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://jonny-huang.github.io/projects/10_feasibility_05/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Jonny Huang">
      <meta itemprop="description" content="Jonny Huang 的學習筆記">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jonny Huang 的學習筆記">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          化繁為簡：05 後端篇(四)Controller
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新於</span>
        <time title="修改時間：2021/06/30 11:06:58" itemprop="dateModified" datetime="2021-06-30T11:06:58+08:00">2021/06/30</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Projects/" itemprop="url" rel="index"><span itemprop="name">Projects</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><img src="/images/projects/feasibility/05/feasibility_05_001.png" alt="img">  </p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在上一篇 <a href="/projects/09_feasibility_04/">化繁為簡：04 後端篇(三)REST</a> 我們最後建立一個 內含 REST 服務的 <code>ProductsController</code>，但是實務上，一般不會直接透過 GET 將清單資料一次全部下載，因為當資料筆數過大時有可能會被中斷，所以我們需要再提供分批下載的功能，此外對於基本資料的處理來說，一但扣除掉因資料特性而有所差異的商業邏輯，Controller 的程式碼幾乎雷同，所以這一篇我們就嘗試幫 Controller 減肥塑身。  </p>
<span id="more"></span>  

<h1 id="CloudContext-增肥"><a href="#CloudContext-增肥" class="headerlink" title="CloudContext 增肥"></a>CloudContext 增肥</h1><p>在處理 Controller 之前，我們先針對 <code>CloudContext</code> 加入更多功能，因為當它可以做的事情越多時，Controller 程式碼就會越少，首先在 <code>Models</code> 資料夾內建立 <code>_DataContext.cs</code>，我們針對基本資料建立相關<strong>介面</strong>(<strong>Interface</strong>)，程式碼如下：<br><img src="/images/projects/feasibility/05/feasibility_05_002.png" alt="img">  </p>
<p>接著將對資料表做<strong>新增</strong>、<strong>修改</strong>、<strong>刪除</strong>時，基本資料所需要調整的方式製作成擴充方法，有看過<a href="/projects/09_feasibility_04/">上一篇文章</a>應該就會知道筆者會套用到 Controller 哪個地方，程式碼如下：<br><img src="/images/projects/feasibility/05/feasibility_05_003.png" alt="img">  </p>
<blockquote>
<p>因為擴充方法 <code>TrySave</code> 與資料庫有關，所以也移至此檔案內。  </p>
</blockquote>
<p>因為我們資料庫是以 <code>disable = true</code> 來表示該筆資料已經被<strong>刪除</strong>，所以正常情況下，我們在查詢時的條件式應該都需要增加  <code>disable = false</code> 來過濾已刪除的資料，但是我們其實可以在 <code>DbContext</code> 內的 <code>OnModelCreating</code> 內自動添加，這樣我們就不會不小心漏掉。<br>因為我們是採用 <strong>Database First</strong>，如果直接在 <code>CloudContext</code> 內添加，內每次透過 EF 工具做同步時額外添加的程式碼就會被洗掉，所以這邊採用在外包一層類別方式來處理，我們建立一個 <code>DataContext</code> 類別並繼承自 <code>CloudContext</code>，程式碼如下：<br><img src="/images/projects/feasibility/05/feasibility_05_004.png" alt="img">  </p>
<blockquote>
<p>我們在 <code>OnModelCreating</code> 內執行 <code>base.OnModelCreating(modelBuilder);</code>，這樣 <code>CloudContext</code> 的 <code>OnModelCreating</code> 就不會直接被覆蓋掉。  </p>
</blockquote>
<p>這邊我們順便增加 <code>GetTypeList</code> 方法，用來替我們去 <code>SysTypes</code> 抓取參數代碼資料，程式碼如下：<br><img src="/images/projects/feasibility/05/feasibility_05_007.png" alt="img">  </p>
<blockquote>
<p>預設共用代碼表為 <code>company_uid=00000000-0000-0000-0000-000000000000</code>，我們也可以針對公司個別做代碼定義。<br><img src="/images/projects/feasibility/05/feasibility_05_005.png" alt="img"><br>另外我們也可以透過<strong>常數</strong>(<code>const</code>)方式來呼叫方法，避免字串參數輸入錯誤。<br><img src="/images/projects/feasibility/05/feasibility_05_008.png" alt="img">  </p>
</blockquote>
<p><code>_DataContext.cs</code> 完整程式碼如下:  </p>
<figure class="highlight cs"><figcaption><span>_DataContext.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Linq.Expressions;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebAPI</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> <span class="title">Models</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IDisable</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">bool</span> Disable &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IDisableRow</span> : <span class="title">IDisable</span></span><br><span class="line">        &#123;</span><br><span class="line">            Guid RemovedBy &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">            DateTime? RemovedDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IDataRow</span> : <span class="title">IDisableRow</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">long</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">            Guid Uid &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">            Guid CreatedBy &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">            DateTime CreatedDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">            <span class="built_in">string</span> Notes &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">            Guid CompanyUid &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">SysProduct</span> : <span class="title">IDataRow</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">CloudContext</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">CloudContext</span>(<span class="params">DbContextOptions&lt;DataContext&gt; options</span>) : <span class="title">base</span>(<span class="params">options</span>)</span> &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">DataContext</span> : <span class="title">CloudContext</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">DataContext</span>(<span class="params"></span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">DataContext</span>(<span class="params">DbContextOptions&lt;DataContext&gt; options</span>) : <span class="title">base</span>(<span class="params">options</span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder modelBuilder</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">base</span>.OnModelCreating(modelBuilder);</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> entityType <span class="keyword">in</span> modelBuilder.Model.GetEntityTypes()</span><br><span class="line">                        .Where(e =&gt; <span class="keyword">typeof</span>(IDisable).IsAssignableFrom(e.ClrType)))</span><br><span class="line">                &#123;</span><br><span class="line">                    modelBuilder.Entity(entityType.ClrType).Property&lt;<span class="built_in">bool</span>&gt;(<span class="string">&quot;Disable&quot;</span>);</span><br><span class="line">                    <span class="keyword">var</span> parameter = Expression.Parameter(entityType.ClrType, <span class="string">&quot;e&quot;</span>);</span><br><span class="line">                    <span class="keyword">var</span> body = Expression.Equal(</span><br><span class="line">                        Expression.Call(<span class="keyword">typeof</span>(EF), <span class="keyword">nameof</span>(EF.Property), <span class="keyword">new</span>[] &#123; <span class="keyword">typeof</span>(<span class="built_in">bool</span>) &#125;,</span><br><span class="line">                            parameter, Expression.Constant(<span class="string">&quot;Disable&quot;</span>)), </span><br><span class="line">                        Expression.Constant(<span class="literal">false</span>)</span><br><span class="line">                    );</span><br><span class="line"></span><br><span class="line">                    modelBuilder.Entity(entityType.ClrType).HasQueryFilter(Expression.Lambda(body, parameter));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">internal</span> IDictionary&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; <span class="title">GetTypeList</span>(<span class="params"><span class="built_in">string</span> groupName</span>)</span> =&gt; GetTypeList(groupName, Guid.Empty);</span><br><span class="line">            <span class="function"><span class="keyword">internal</span> IDictionary&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; <span class="title">GetTypeList</span>(<span class="params"><span class="built_in">string</span> groupName, Guid companyUid</span>)</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> types = (</span><br><span class="line">                    <span class="keyword">from</span> f <span class="keyword">in</span> SysTypes</span><br><span class="line">                    <span class="keyword">where</span> f.GroupName == groupName &amp;&amp; f.CompanyUid == companyUid</span><br><span class="line">                    <span class="keyword">orderby</span> f.<span class="function">Sort</span></span><br><span class="line"><span class="function">                    <span class="keyword">select</span> <span class="keyword">new</span> <span class="title">KeyValuePair</span>&lt;<span class="title">int</span>, <span class="title">string</span>&gt;(<span class="params">f.Value, f.Name</span>)</span></span><br><span class="line"><span class="function">                ).<span class="title">ToDictionary</span>(<span class="params">x =&gt; x.Key, x =&gt; x.Value</span>)</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!types.Any() &amp;&amp; companyUid != Guid.Empty)</span><br><span class="line">                &#123;</span><br><span class="line">                    types = (</span><br><span class="line">                       <span class="keyword">from</span> f <span class="keyword">in</span> SysTypes</span><br><span class="line">                       <span class="keyword">where</span> f.GroupName == groupName &amp;&amp; f.CompanyUid == Guid.Empty</span><br><span class="line">                       <span class="keyword">orderby</span> f.<span class="function">Sort</span></span><br><span class="line"><span class="function">                       <span class="keyword">select</span> <span class="keyword">new</span> <span class="title">KeyValuePair</span>&lt;<span class="title">int</span>, <span class="title">string</span>&gt;(<span class="params">f.Value, f.Name</span>)</span></span><br><span class="line"><span class="function">                    ).<span class="title">ToDictionary</span>(<span class="params">x =&gt; x.Key, x =&gt; x.Value</span>)</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> types;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">Ext</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ToAddStaus</span>(<span class="params"><span class="keyword">this</span> Models.IDataRow data, Models.SysEmployee employee</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (data == <span class="literal">null</span> || employee == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            data.Uid = Guid.NewGuid();</span><br><span class="line">            data.CompanyUid = employee.CompanyUid;</span><br><span class="line">            data.CreatedBy = employee.Uid;</span><br><span class="line">            data.CreatedDate = DateTime.Now;</span><br><span class="line">            data.Disable = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (data.Notes == <span class="literal">null</span>)</span><br><span class="line">                data.Notes = <span class="built_in">string</span>.Empty;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ToUpdateStaus</span>(<span class="params"><span class="keyword">this</span> Models.IDataRow data, Models.SysEmployee employee</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (data == <span class="literal">null</span> || employee == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            data.CreatedBy = employee.Uid;</span><br><span class="line">            data.CreatedDate = DateTime.Now;</span><br><span class="line">            data.Disable = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ToDeleteStaus</span>(<span class="params"><span class="keyword">this</span> Models.IDisableRow data, Models.SysEmployee employee</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (data == <span class="literal">null</span> || employee == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            data.RemovedBy = employee.Uid;</span><br><span class="line">            data.RemovedDate = DateTime.Now;</span><br><span class="line">            data.Disable = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">TrySave</span>(<span class="params"><span class="keyword">this</span> DbContext db, <span class="keyword">out</span> <span class="built_in">string</span> message</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                db.SaveChanges();</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                message = ex.Message;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            message = <span class="built_in">string</span>.Empty;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>  

<p>最後要記得修改 <code>Startup.cs</code> 的 <code>ConfigureServices</code> 函式，將 <code>CloudContext</code> 改成 <code>DataContext</code>。<br><img src="/images/projects/feasibility/05/feasibility_05_006.png" alt="img">  </p>
<h1 id="Controller-抽離"><a href="#Controller-抽離" class="headerlink" title="Controller 抽離"></a>Controller 抽離</h1><p>其實大部分的 Controller 只有資料抓取與篩選的邏輯有差異，其他的流程幾乎不會改變，所以如果我們可以將固定不變的程式碼抽來出來，那 Controller 就會只剩下來商業邏輯部分，這不僅會讓程式碼變乾淨，而且維護上也會更容易。<br><img src="/images/projects/feasibility/05/feasibility_05_009.png" alt="img">  </p>
<p>我們在 <code>Controller</code> 資料夾下建立一個類別 <code>_DataController.cs</code>，因為 DataController 只有共通的程式碼，本身不是完整的程式，所以我們將它訂定為<strong>抽象類別</strong>(<code>abstract class</code>)，程式碼如下：  </p>
<figure class="highlight cs"><figcaption><span>_DataController.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Caching.Memory;</span><br><span class="line"><span class="keyword">using</span> WebAPI.Models;</span><br><span class="line"><span class="keyword">using</span> WebAPI.ViewModels;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebAPI.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">DataController</span>&lt;<span class="title">View</span>, <span class="title">DetailView</span>&gt; : <span class="title">ControllerBase</span></span><br><span class="line">        <span class="keyword">where</span> <span class="title">View</span> : <span class="keyword">class</span></span><br><span class="line">        <span class="keyword">where</span> <span class="title">DetailView</span> : <span class="keyword">class</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">readonly</span> DataContext DB;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">readonly</span> IMemoryCache cache;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">readonly</span> <span class="built_in">string</span> cacheName;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DataController</span>(<span class="params">DataContext db, IMemoryCache memoryCache, <span class="built_in">string</span> cacheName</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            DB = db;</span><br><span class="line">            cache = memoryCache;</span><br><span class="line">            <span class="keyword">this</span>.cacheName = cacheName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="built_in">bool</span> <span class="title">IsAuthenticated</span>(<span class="params"><span class="keyword">out</span> SysEmployee userInfo, <span class="keyword">out</span> <span class="built_in">string</span> message</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            message = <span class="built_in">string</span>.Empty;</span><br><span class="line">            <span class="keyword">if</span> (HttpContext?.Items != <span class="literal">null</span> &amp;&amp; HttpContext.Items.ContainsKey(<span class="string">&quot;emp&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                userInfo = HttpContext.Items[<span class="string">&quot;emp&quot;</span>] <span class="keyword">as</span> SysEmployee;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                userInfo = <span class="keyword">new</span> SysEmployee</span><br><span class="line">                &#123;</span><br><span class="line">                    CompanyUid = Guid.Empty,</span><br><span class="line">                    UserUid = Guid.Empty,</span><br><span class="line">                    Email = <span class="built_in">string</span>.Empty</span><br><span class="line">                &#125;;</span><br><span class="line">                message = <span class="string">&quot;查無使用者資訊&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="built_in">string</span> <span class="title">CacheName</span>(<span class="params">Guid companyUid</span>)</span> =&gt; <span class="string">$&quot;<span class="subst">&#123;cacheName&#125;</span>_<span class="subst">&#123;companyUid&#125;</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="title">List</span>&lt;<span class="title">View</span>&gt; <span class="title">GetViewList</span>(<span class="params">Guid companyUid</span>)</span> =&gt; <span class="keyword">new</span> List&lt;View&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">internal</span> List&lt;View&gt; <span class="title">DataList</span>(<span class="params">Guid companyUid</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> cacheName = CacheName(companyUid);</span><br><span class="line">            <span class="keyword">if</span> (!cache.TryGetValue(cacheName, <span class="keyword">out</span> List&lt;View&gt; data))</span><br><span class="line">            &#123;</span><br><span class="line">                data = GetViewList(companyUid);</span><br><span class="line">                <span class="keyword">if</span> (data.Any())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> cacheEntryOptions = <span class="keyword">new</span> MemoryCacheEntryOptions()</span><br><span class="line">                        .SetSlidingExpiration(Lib.CACHE_TIME);</span><br><span class="line">                    cache.Set(cacheName, data, cacheEntryOptions);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> data ?? <span class="keyword">new</span> List&lt;View&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Get</span>(<span class="params"></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsAuthenticated(<span class="keyword">out</span> SysEmployee userInfo, <span class="keyword">out</span> <span class="built_in">string</span> message))</span><br><span class="line">                <span class="keyword">return</span> BadRequest(message);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> query = DataList(userInfo.CompanyUid);</span><br><span class="line">            <span class="keyword">if</span> (!query.Any())</span><br><span class="line">                <span class="keyword">return</span> Ok(Lib.EmptyResult);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Ok(Lib.QueryResult(query));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> DetailView <span class="title">GetDetail</span>(<span class="params">Guid companyUid, Guid uid</span>)</span> =&gt; <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpGet(<span class="meta-string">&quot;&#123;uid&#125;&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Get</span>(<span class="params">Guid uid</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsAuthenticated(<span class="keyword">out</span> SysEmployee userInfo, <span class="keyword">out</span> <span class="built_in">string</span> message))</span><br><span class="line">                <span class="keyword">return</span> BadRequest(message);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> detail = GetDetail(userInfo.CompanyUid, uid);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (detail == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;查無資料&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Ok(Lib.QueryResult(detail));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> ResultViewModel <span class="title">UpdateData</span>(<span class="params">DetailView view, SysEmployee userInfo</span>)</span> =&gt; <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpPost</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Post</span>(<span class="params">[FromBody] DetailView view</span>)</span> =&gt; Put(view);</span><br><span class="line">        [<span class="meta">HttpPut</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Put</span>(<span class="params">[FromBody] DetailView view</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsAuthenticated(<span class="keyword">out</span> SysEmployee userInfo, <span class="keyword">out</span> <span class="built_in">string</span> message))</span><br><span class="line">                <span class="keyword">return</span> BadRequest(message);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> result = UpdateData(view, userInfo);</span><br><span class="line">            <span class="keyword">if</span> (result == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;null&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!result.Success)</span><br><span class="line">                <span class="keyword">return</span> BadRequest(result.Message);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> cacheName = CacheName(userInfo.CompanyUid);</span><br><span class="line">            cache.Remove(cacheName);</span><br><span class="line">            <span class="keyword">return</span> Ok(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> ResultViewModel <span class="title">RemoveDate</span>(<span class="params">Guid uid, SysEmployee userInfo</span>)</span> =&gt; <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpDelete(<span class="meta-string">&quot;&#123;uid&#125;&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Delete</span>(<span class="params">Guid uid</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsAuthenticated(<span class="keyword">out</span> SysEmployee userInfo, <span class="keyword">out</span> <span class="built_in">string</span> message))</span><br><span class="line">                <span class="keyword">return</span> BadRequest(message);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> result = RemoveDate(uid, userInfo);</span><br><span class="line">            <span class="keyword">if</span> (result == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> BadRequest(<span class="string">&quot;null&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!result.Success)</span><br><span class="line">                <span class="keyword">return</span> BadRequest(result.Message);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">string</span> cacheName = CacheName(userInfo.CompanyUid);</span><br><span class="line">            cache.Remove(cacheName);</span><br><span class="line">            <span class="keyword">return</span> Ok(Lib.RemoveResult());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>  

<blockquote>
<p>在這邊我們還利用 <strong>MemoryCache</strong> 來暫存清單資料，如果在快取時間內發出請求，系統會直接抓取快取料，這樣就可以減輕資料庫負擔，為了確保資料一致性，我們在執行新增、修該、刪除作業時會順便清除快取資，快取時間一般需要考量許多因素(例如：資料更新頻率、可用記憶體容量)。<br><img src="/images/projects/feasibility/05/feasibility_05_010.png" alt="img"><br>因為我們資料表允許多家公司並存資料，所以我們快取名稱會增加 <code>companyUid</code> 來區隔。  </p>
</blockquote>
<h2 id="批次傳輸"><a href="#批次傳輸" class="headerlink" title="批次傳輸"></a>批次傳輸</h2><p>當你資料超過上萬筆時，如果你一次抓取全部的資料那使用者的等待時間可能會很久，用戶體驗上就會比較不好，甚至會以為程式當掉了，當然時間過長也會有系統逾時(Timeout)的風險，所以我們在 Controller 內在增加批次抓取清單功能。<br>首先我們建立一個 <code>QueryParameters</code> 來存放資料抓取區間資訊，程式碼如下：  </p>
<figure class="highlight cs"><figcaption><span>_QueryParameters.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WebAPI.ViewModels</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">QueryParameters</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PageSize &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> PageNumber &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Filter &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>  

<p>接著我們在 <code>DataController</code> 內增加可以讀取<strong>資料筆數</strong>的方法 <code>GetCount</code>，以及可以依照 <code>QueryParameters</code> 的資訊抓取所需的區間資料的方法 <code>GetBatch</code>，程式碼如下：  </p>
<figure class="highlight cs"><figcaption><span>_DataController.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">WebAPI.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">DataController</span>&lt;<span class="title">View</span>, <span class="title">DetailView</span>&gt; : <span class="title">ControllerBase</span></span><br><span class="line">        <span class="keyword">where</span> <span class="title">View</span> : <span class="keyword">class</span></span><br><span class="line">        <span class="keyword">where</span> <span class="title">DetailView</span> : <span class="keyword">class</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="built_in">int</span> <span class="title">GetRowCount</span>(<span class="params">Guid companyUid</span>)</span> =&gt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpGet(<span class="meta-string">&quot;count&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetCount</span>(<span class="params"></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsAuthenticated(<span class="keyword">out</span> SysEmployee userInfo, <span class="keyword">out</span> <span class="built_in">string</span> message))</span><br><span class="line">                <span class="keyword">return</span> BadRequest(message);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> count = GetRowCount(userInfo.CompanyUid);</span><br><span class="line">            <span class="built_in">string</span> cacheName = CacheName(userInfo.CompanyUid);</span><br><span class="line">            <span class="keyword">if</span> (cache.TryGetValue(cacheName, <span class="keyword">out</span> List&lt;View&gt; data))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (count == data.Count)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> cacheEntryOptions = <span class="keyword">new</span> MemoryCacheEntryOptions()</span><br><span class="line">                        .SetSlidingExpiration(Lib.CACHE_TIME);</span><br><span class="line">                    cache.Set(cacheName, data, cacheEntryOptions);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    cache.Remove(cacheName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Ok(Lib.QueryResult(count));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpGet(<span class="meta-string">&quot;batch&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">GetBatch</span>(<span class="params">[FromQuery] QueryParameters paramter</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!IsAuthenticated(<span class="keyword">out</span> SysEmployee userInfo, <span class="keyword">out</span> <span class="built_in">string</span> message))</span><br><span class="line">                <span class="keyword">return</span> BadRequest(message);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> data = DataList(userInfo.CompanyUid)</span><br><span class="line">                .Skip(paramter.PageNumber * paramter.PageSize)</span><br><span class="line">                .Take(paramter.PageSize)</span><br><span class="line">                .ToList();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!data.Any())</span><br><span class="line">                <span class="keyword">return</span> Ok(Lib.EmptyResult);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Ok(Lib.QueryResult(data));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>  

<blockquote>
<p>除了 <code>QueryParameters</code>，其實我們也可以透過 HTTP Header：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Range">Content-Range</a> 來當作傳入的參數，所以我們可以像 <code>AuthorizationMiddleware</code> 將 Token 轉換成 <code>SysEmployee</code> 方式，在 Middleware 讀取 Request 是否含有 Content-Range 的 Header，有的話就抓取出來在塞到 Query Parameter 內，這樣就可以同時支援2種方式。<br>批次傳輸這個功能主要是筆者為了解決使用者在無線網路不穩定的環境之下，使用者操作上會斷斷續續的問題，所以資料全部傳到前端，由前端做處理，但是使用時還是要注意資安問題，對於敏感性的資料應該僅傳送必要資料就好。  </p>
</blockquote>
<h1 id="修改-ProductsController"><a href="#修改-ProductsController" class="headerlink" title="修改 ProductsController"></a>修改 ProductsController</h1><p>最後我們來看看 ProductsController 可以簡化到什麼程度，首先我們增加一個 <code>CacheKey</code> 類別用來存放 Controller 的快取名稱，集中存放可以避免不小心命名重複，程式碼如下：<br><img src="/images/projects/feasibility/05/feasibility_05_011.png" alt="img">  </p>
<p>再來我們修改 <code>ProductsController</code>，變成繼承自 <code>DataController</code>，接著複寫相關方法，程式碼如下：  </p>
<figure class="highlight cs"><figcaption><span>ProductsController.cs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Caching.Memory;</span><br><span class="line"><span class="keyword">using</span> WebAPI.Models;</span><br><span class="line"><span class="keyword">using</span> WebAPI.ViewModels;</span><br><span class="line"><span class="keyword">using</span> DetailView = WebAPI.ViewModels.ProductDetailViewModel;</span><br><span class="line"><span class="keyword">using</span> Model = WebAPI.Models.SysProduct;</span><br><span class="line"><span class="keyword">using</span> View = WebAPI.ViewModels.ProductViewModel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebAPI.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Route(<span class="meta-string">&quot;api/[controller]&quot;</span>)</span>]</span><br><span class="line">    [<span class="meta">ApiController</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">ProductsController</span> : <span class="title">DataController</span>&lt;<span class="title">View</span>, <span class="title">DetailView</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> DbSet&lt;Model&gt; table;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ProductsController</span>(<span class="params">DataContext db, IMemoryCache cache</span>) : <span class="title">base</span>(<span class="params">db, cache, CacheKey.Product</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            table = DB.SysProducts;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">int</span> <span class="title">GetRowCount</span>(<span class="params">Guid companyUid</span>)</span> =&gt; table.Count(x =&gt; x.CompanyUid == companyUid);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> ResultViewModel <span class="title">RemoveDate</span>(<span class="params">Guid uid, SysEmployee userInfo</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> model = table.FirstOrDefault(x =&gt; x.Uid == uid &amp;&amp; x.CompanyUid == userInfo.CompanyUid);</span><br><span class="line">            <span class="keyword">if</span> (model == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> Lib.BadResult(<span class="string">&quot;查無資料&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> order = DB.SysOrderItems.FirstOrDefault(x =&gt; x.ProductUid == model.Uid &amp;&amp; x.CompanyUid == userInfo.CompanyUid);</span><br><span class="line">            <span class="keyword">if</span> (order != <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> Lib.BadResult(<span class="string">&quot;此產品有關聯的訂單，無法刪除&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> quotation = DB.SysQuotationItems.FirstOrDefault(x =&gt; x.ProductUid == model.Uid &amp;&amp; x.CompanyUid == userInfo.CompanyUid);</span><br><span class="line">            <span class="keyword">if</span> (quotation != <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> Lib.BadResult(<span class="string">&quot;此產品有關聯的報價單，無法刪除&quot;</span>);</span><br><span class="line"></span><br><span class="line">            model.ToDeleteStaus(userInfo);</span><br><span class="line">            <span class="keyword">if</span> (!DB.TrySave(<span class="keyword">out</span> <span class="built_in">string</span> message))</span><br><span class="line">                <span class="keyword">return</span> Lib.BadResult(message);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Lib.RemoveResult();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> List&lt;View&gt; <span class="title">GetViewList</span>(<span class="params">Guid companyUid</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> stateType = DB.GetTypeList(SystemType.ProductStateType);</span><br><span class="line">            <span class="keyword">var</span> data = (</span><br><span class="line">                <span class="keyword">from</span> f <span class="keyword">in</span> table</span><br><span class="line">                <span class="keyword">join</span> type <span class="keyword">in</span> DB.SysProductTypes <span class="keyword">on</span> f.TypeUid <span class="keyword">equals</span> type.Uid <span class="keyword">into</span> ps1</span><br><span class="line">                <span class="keyword">from</span> type <span class="keyword">in</span> ps1.DefaultIfEmpty()</span><br><span class="line">                <span class="keyword">where</span> f.CompanyUid == companyUid</span><br><span class="line">                <span class="keyword">orderby</span> f.Code, f.Name</span><br><span class="line">                <span class="keyword">select</span> f.ToView(type, stateType)</span><br><span class="line">            ).ToList();</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> DetailView <span class="title">GetDetail</span>(<span class="params">Guid companyUid, Guid uid</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            DateTime dt = DateTime.Today;</span><br><span class="line">            <span class="keyword">var</span> price = (</span><br><span class="line">                <span class="keyword">from</span> f <span class="keyword">in</span> DB.SysProductPrices</span><br><span class="line">                <span class="keyword">where</span> f.ProductUid == uid &amp;&amp; f.CompanyUid == companyUid</span><br><span class="line">                    &amp;&amp; f.BeginDate &lt;= dt &amp;&amp; (f.HasEnd == <span class="literal">false</span> || (f.HasEnd == <span class="literal">true</span> &amp;&amp; f.EndDate.Value &gt; dt))</span><br><span class="line">                <span class="keyword">orderby</span> f.Id <span class="keyword">descending</span></span><br><span class="line">                <span class="keyword">select</span> f</span><br><span class="line">            ).FirstOrDefault();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> stateType = DB.GetTypeList(SystemType.ProductStateType);</span><br><span class="line">            <span class="keyword">var</span> detail = (</span><br><span class="line">                <span class="keyword">from</span> f <span class="keyword">in</span> table</span><br><span class="line">                <span class="keyword">join</span> type <span class="keyword">in</span> DB.SysProductTypes <span class="keyword">on</span> f.TypeUid <span class="keyword">equals</span> type.Uid <span class="keyword">into</span> ps1</span><br><span class="line">                <span class="keyword">from</span> type <span class="keyword">in</span> ps1.DefaultIfEmpty()</span><br><span class="line">                <span class="keyword">join</span> creator <span class="keyword">in</span> DB.SysEmployees <span class="keyword">on</span> f.CreatedBy <span class="keyword">equals</span> creator.Uid <span class="keyword">into</span> ps2</span><br><span class="line">                <span class="keyword">from</span> creator <span class="keyword">in</span> ps2.DefaultIfEmpty()</span><br><span class="line">                <span class="keyword">where</span> f.Uid == uid &amp;&amp; f.CompanyUid == companyUid</span><br><span class="line">                <span class="keyword">select</span> f.ToDetailView(creator, type, price, stateType)</span><br><span class="line">            ).FirstOrDefault();</span><br><span class="line">            <span class="keyword">return</span> detail;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> ResultViewModel <span class="title">UpdateData</span>(<span class="params">DetailView view, SysEmployee userInfo</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!view.IsValid(<span class="keyword">out</span> <span class="built_in">string</span> message))</span><br><span class="line">                <span class="keyword">return</span> Lib.BadResult(message);</span><br><span class="line"></span><br><span class="line">            Model model = <span class="literal">null</span>;</span><br><span class="line">            <span class="built_in">bool</span> isAdd = view.Uid == Guid.Empty;</span><br><span class="line">            <span class="keyword">if</span> (isAdd)</span><br><span class="line">            &#123;</span><br><span class="line">                model = view.ToModel();</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(model.Code))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> queryOldProduct = table.FirstOrDefault(x =&gt; x.Code == model.Code &amp;&amp; x.CompanyUid == userInfo.CompanyUid);</span><br><span class="line">                    <span class="keyword">if</span> (queryOldProduct != <span class="literal">null</span>)</span><br><span class="line">                        <span class="keyword">return</span> Lib.BadResult(<span class="string">&quot;產品編號重複&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                model.ToAddStaus(userInfo);</span><br><span class="line">                table.Add(model);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                model = table.FirstOrDefault(x =&gt; x.Uid == view.Uid &amp;&amp; x.CompanyUid == userInfo.CompanyUid);</span><br><span class="line">                <span class="keyword">if</span> (model == <span class="literal">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> Lib.BadResult(<span class="string">&quot;查無資料&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(view.Code) &amp;&amp; view.Code != model.Code)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> queryOldProduct = table.FirstOrDefault(x =&gt; x.Code == view.Code &amp;&amp; x.CompanyUid == userInfo.CompanyUid);</span><br><span class="line">                    <span class="keyword">if</span> (queryOldProduct != <span class="literal">null</span> &amp;&amp; model.Uid != queryOldProduct.Uid)</span><br><span class="line">                        <span class="keyword">return</span> Lib.BadResult(<span class="string">&quot;產品編號重複&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                model.UpdateModel(view);</span><br><span class="line">                model.ToUpdateStaus(userInfo);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!DB.TrySave(<span class="keyword">out</span> message))</span><br><span class="line">                <span class="keyword">return</span> Lib.BadResult(message);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Lib.UpdateResult(isAdd, model.Uid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>  

<p>我們可以看到 <code>ProductsController</code> 內就只剩下查詢、新增、修改、刪除的資料處理邏輯，當然也可以再增加其他 API 功能。  </p>
<h1 id="後記"><a href="#後記" class="headerlink" title="後記"></a>後記</h1><p>如果嘗試在建立一個新的 Controller 就會發現步驟很簡單：  </p>
<ul>
<li><p>建立 ViewModel 類別，再將對應的 Model 類別的屬性複製過來修改。  </p>
</li>
<li><p>ViewModel 內的擴充方法可以複製既有的 ViewModel 程式碼，大部分需要依照屬性(欄位)做調整。  </p>
</li>
<li><p>建立 Controller 類別，複製既有的 Controller 過來修改。  </p>
</li>
</ul>
<p>利用複製貼上寫程式其實是很不嚴謹的，因為做得太快反而沒有仔細思考，但是編譯過程也可以幫我們排除重大錯誤，大部分剩下<strong>用戶端資料顯示不完全</strong>或是<strong>部分欄位資料沒寫入資料庫</strong>，這部分程式設計師在初期測試應就可以發現，既使沒注意，事後排除應該也不難。  </p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Projects/" rel="tag"># Projects</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/projects/09_feasibility_04/" rel="prev" title="化繁為簡：04 後端篇(三)REST">
                  <i class="fa fa-chevron-left"></i> 化繁為簡：04 後端篇(三)REST
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/projects/11_feasibility_06/" rel="next" title="化繁為簡：06 前端篇(一)">
                  化繁為簡：06 前端篇(一) <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jonny Huang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 強力驅動
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
